<html>
  <body>
    <script type="module">
      import { runTests } from '@web/test-runner-mocha';
      import { assert } from '@esm-bundle/chai';

      window.hlx = {
        RUM_MANUAL_ENHANCE: true,
      };

      import { sampleRUM } from '../../src/index.js';

      /* eslint-env mocha */
      runTests(async () => {
        beforeEach(() => {
          const usp = new URLSearchParams(window.location.search);
          usp.append('rum', 'off');
          window.history.replaceState({}, '', `${window.location.pathname}?${usp.toString()}`);
        });

        afterEach(() => {
          const usp = new URLSearchParams(window.location.search);
          usp.delete('rum');
          window.history.replaceState({}, '', `${window.location.pathname}?${usp.toString()}`);
          // eslint-disable-next-line no-underscore-dangle
          window.hlx.rum = undefined;

          const enhancer = document.querySelector('script[src*="rum-enhancer"]');
          if (enhancer) {
            enhancer.remove();
          }
        });
        
        describe('sampleRUM - after load event', () => {
          it('rum manual enhance mode - control enhancement', () => {
            assert.ok(!document.querySelector('script[src*="rum-enhancer"]'));
            sampleRUM();
            assert.ok(!document.querySelector('script[src*="rum-enhancer"]'));
            assert.strictEqual(typeof sampleRUM.enhance, 'function');
            sampleRUM.enhance();
            // at this stage, rum-enhancer should not be loaded because rum has not been enabled
            assert.ok(!document.querySelector('script[src*="rum-enhancer"]'));
          });
        });
      });
    </script>
  </body>
</html>