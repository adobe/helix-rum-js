<html>

<body>
  <script type="module">
    import { runTests } from '@web/test-runner-mocha';
    import { assert } from '@esm-bundle/chai';

    const DELAY_MS = 1000;

    const loadFixture = (fixture) => new Promise((resolve, reject) => {
      const iframe = document.createElement('iframe');
      iframe.style.display = 'none';
      iframe.src = `/test/fixtures/loading/${fixture}`;

      const cleanup = () => {
        clearTimeout(timeoutId);
        iframe.remove();
      };

      const timeoutId = setTimeout(() => {
        cleanup();
        reject(new Error(`Timed out waiting for ${fixture}`));
      }, 15000);

      iframe.addEventListener('load', () => {
        const { testTimeline: timeline } = iframe.contentWindow;
        cleanup();
        if (!timeline || !timeline.complete) {
          reject(new Error(`Invalid timeline for ${fixture}`));
          return;
        }
        resolve(timeline);
      });

      document.body.append(iframe);
    });

    /* eslint-env mocha */
    runTests(async () => {
      describe('standalone script loading mode', () => {
        it('defer undelayed', async () => {
          const timeline = await loadFixture('standalone-defer-undelayed.html');
          assert.isTrue(timeline.rumAttrs.defer);
          assert.isFalse(timeline.rumAttrs.async);
          assert.isAtLeast(timeline.appScript, timeline.rum.responseEnd - 100);
        });

        it('async undelayed', async () => {
          const timeline = await loadFixture('standalone-async-undelayed.html');
          assert.isFalse(timeline.rumAttrs.defer);
          assert.isTrue(timeline.rumAttrs.async);
          assert.exists(timeline.rum);
          assert.exists(timeline.appScript);
        });

        it('defer delayed', async () => {
          const timeline = await loadFixture('standalone-defer-delayed.html');
          assert.isAtLeast(timeline.rum.duration, DELAY_MS - 50);
          assert.isAtLeast(timeline.nav.domContentLoadedEventEnd, timeline.rum.responseEnd - 120);
          assert.isAtLeast(timeline.appScript, timeline.rum.responseEnd - 120);
        });

        it('async delayed', async () => {
          const timeline = await loadFixture('standalone-async-delayed.html');
          assert.isAtLeast(timeline.rum.duration, DELAY_MS - 50);
          assert.isBelow(timeline.nav.domContentLoadedEventEnd, timeline.rum.responseEnd - 200);
          assert.isBelow(timeline.appScript, timeline.rum.responseEnd - 200);
        });
      });
    });
  </script>
</body>

</html>
