<html>

<head>
  <script>
    // this is set-up for the test
    window.RUM_PARAMS = { program: 'pXXXXXX', environment: 'eYYYYYY' };
    window.sendBeaconArgs = {
      url: '',
      data: {},
    };
    // eslint-disable-next-line no-underscore-dangle
    navigator._sendBeacon = navigator.sendBeacon;
    navigator.sendBeacon = (url, data) => {
      const json = JSON.parse(data);
      if (json.checkpoint === 'top') {
        sendBeaconArgs.url = url;
        sendBeaconArgs.data = json;
      }
      return true;
    };

    // Pre-declare conflicting global variables that micro.js uses
    var c = 'ORIGINAL_C';
    var d = 'ORIGINAL_D';
    var q = 'ORIGINAL_Q';
    var v = 'ORIGINAL_V';
    var w = 'ORIGINAL_W';
    var r = 'ORIGINAL_R';
    var n = 'ORIGINAL_N';
    var a = 'ORIGINAL_A';
    
    // Store original values to test if they get overwritten
    window.ORIGINAL_VALUES = { c, d, q, v, w, r, n, a };
  </script>
  <script defer data-script="standalone.js" data-rate="on" src="../../src/micro.js">
  </script>
</head>

<body>
  <script type="module">
    import { runTests } from '@web/test-runner-mocha';
    import { assert } from '@esm-bundle/chai';
    /* eslint-env mocha */
    runTests(async () => {
      describe('Micro-Loader - Global Variable Conflicts', () => {
        it('Should not overwrite pre-existing global variables', async () => {
          await new Promise(resolve => setTimeout(resolve, 500));
          
          // Test that original values are preserved (this should fail with current implementation)
          assert.strictEqual(window.c, 'ORIGINAL_C');
          assert.strictEqual(window.d, 'ORIGINAL_D');
          assert.strictEqual(window.q, 'ORIGINAL_Q');
          assert.strictEqual(window.v, 'ORIGINAL_V');
          assert.strictEqual(window.w, 'ORIGINAL_W');
          assert.strictEqual(window.r, 'ORIGINAL_R');
          assert.strictEqual(window.n, 'ORIGINAL_N');
          assert.strictEqual(window.a, 'ORIGINAL_A');
        });
        
        it('Should still function correctly despite conflicts', async () => {
          await new Promise(resolve => setTimeout(resolve, 500));
          
          // Verify that RUM still works
          assert.strictEqual(window.sendBeaconArgs.url, `https://rum.hlx.page/.rum/1?program=pXXXXXX&environment=eYYYYYY`);
          assert.strictEqual(window.sendBeaconArgs.data.checkpoint, 'top');
          assert.strictEqual(window.WAS_SELECTED, true);
        });
      });
    });
  </script>
</body>

</html>